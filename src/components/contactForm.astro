---
import { Icon } from "astro-icon/components";
---

<form class="space-y-6">
  <div
    role="alert"
    class="alert transition-all duration-500 ease-in-out opacity-0 invisible h-0 overflow-hidden mb-0 p-0"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6 shrink-0 stroke-current"
      fill="none"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>teste</span>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="space-y-2">
      <label class="text-sm font-bold uppercase tracking-wider text-slate-500"
        >Nome</label
      >
      <input
        class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-neutral-border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        placeholder="John Doe"
        type="text"
        name="name"
        required
        data-control-input="name"
      />
      <p id="error-name" class="hidden text-red-500"></p>
    </div>
    <div class="space-y-2">
      <label class="text-sm font-bold uppercase tracking-wider text-slate-500"
        >Email</label
      >
      <input
        class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-neutral-border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        placeholder="john@example.com"
        type="email"
        name="email"
        required
        data-control-input="email"
      />
      <p id="error-email" class="hidden text-red-500"></p>
    </div>
  </div>
  <div class="space-y-2">
    <label class="text-sm font-bold uppercase tracking-wider text-slate-500"
      >Assunto</label
    >
    <input
      class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-neutral-border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
      placeholder="Consulta sobre novo projeto"
      type="text"
      name="subject"
      required
      data-control-input="subject"
    />
    <p id="error-subject" class="hidden text-red-500"></p>
  </div>
  <div class="space-y-2">
    <label class="text-sm font-bold uppercase tracking-wider text-slate-500"
      >Mensagem</label
    >
    <textarea
      class="w-full bg-slate-50 dark:bg-background-dark border-slate-200 dark:border-neutral-border rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
      placeholder="Fale-me sobre o seu projeto..."
      rows="4"
      name="message"
      required
      data-control-input="message"></textarea>
    <p id="error-message" class="hidden text-red-500"></p>
  </div>
  <button
    type="submit"
    class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 transition-all flex items-center justify-center gap-2
            disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400"
  >
    Enviar mensagem
    <Icon name="material-symbols:send-sharp" size="24" />
  </button>
</form>

<script>
  import { actions } from "astro:actions";

  const contactForm = document.querySelector("form");
  const submitButton = document.querySelector<HTMLElement>("[type='submit']");
  const inputElement = document.querySelectorAll<HTMLElement>(
    "[data-control-input]",
  );
  const formAlert = document.querySelector<HTMLElement>("[role='alert']");
  const formDataFields: Record<string, HTMLElement | null> = {
    name: document.querySelector<HTMLElement>("#error-name"),
    email: document.querySelector<HTMLElement>("#error-email"),
    subject: document.querySelector<HTMLElement>("#error-subject"),
    message: document.querySelector<HTMLElement>("#error-message"),
  };

  function closeAlert() {
    if (!formAlert) return;
    formAlert.classList.remove(
      "opacity-100",
      "visible",
      "p-4",
      "mb-6",
      "h-auto",
    );
    formAlert.classList.add("opacity-0", "invisible", "p-0", "mb-0", "h-0");
  }

  function setAlert(text: string, typeAlert: string) {
    const spanAlert = formAlert?.querySelector("span");
    if (!formAlert) return;
    formAlert.classList.add(typeAlert);
    formAlert.classList.remove("opacity-0", "invisible", "p-0", "mb-0", "h-0");
    formAlert.classList.add("opacity-100", "visible", "p-4", "mb-6", "h-auto");
    if (spanAlert) spanAlert.innerText = text;

    setTimeout(() => {
      closeAlert();
    }, 10000);
  }

  inputElement.forEach((input) => {
    input.addEventListener("keydown", () => {
      const field = input.getAttribute("name");
      if (!field) return;

      const element = formDataFields[field];
      if (!element) return;

      element.innerText = "";
    });
  });

  contactForm?.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(contactForm);

    submitButton?.setAttribute("disabled", "true");
    const result: { [key: string]: string | any } = await actions
      .postContact(formData)
      .finally(() => {
        submitButton?.removeAttribute("disabled");
      });

    const nameFields = Object?.keys(result?.error?.fields ?? {});

    if (result?.data?.success) {
      contactForm?.reset();
      setAlert(result.data.message, "alert-success");
    }
    if (Object.keys(result?.error).length)
      setAlert(result?.error.message, "alert-error");

    nameFields.forEach((field: string) => {
      const element = formDataFields[field];
      if (!element) return;

      element.classList.remove("hidden");
      element.innerText = "";
      element.append(result?.error?.fields[field]);
    });
  });
</script>
